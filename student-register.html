<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í•™ìƒ ë“±ë¡ - í°ìˆ˜í•™ìŠµ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .register-container {
        max-width: 500px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .register-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group label {
        font-weight: bold;
        color: #333;
        font-size: 16px;
      }

      .form-group input,
      .form-group select {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
      }

      .register-button {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .register-button:hover {
        transform: translateY(-2px);
      }

      .register-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .form-row {
        display: flex;
        gap: 15px;
      }

      .form-row .form-group {
        flex: 1;
      }

      .welcome-message {
        text-align: center;
        margin-bottom: 30px;
      }

      .welcome-message h1 {
        color: #4caf50;
        margin-bottom: 10px;
      }

      .welcome-message p {
        color: #666;
        font-size: 16px;
      }

      .existing-student {
        text-align: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .existing-student button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="register-container">
        <div class="welcome-message">
          <h1>ğŸ« í°ìˆ˜í•™ìŠµ ì‹œì‘í•˜ê¸°</h1>
          <p>í•™ìŠµì„ ì‹œì‘í•˜ê¸° ì „ì— í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
        </div>

        <form class="register-form" id="registerForm">
          <div class="form-group">
            <label for="regionSelect">ì§€ì—­</label>
            <select id="regionSelect" aria-label="ì§€ì—­ ì„ íƒ" required>
              <option value="">ì„ íƒ</option>
            </select>
          </div>

          <div class="form-group">
            <label for="schoolSelect">í•™êµ</label>
            <select id="schoolSelect" aria-label="í•™êµ ì„ íƒ" required disabled>
              <option value="">ì…ë ¥í•´ì£¼ì„¸ìš”</option>
            </select>
            <input type="hidden" id="schoolCode" name="school_code" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="grade">í•™ë…„</label>
              <select id="grade" name="grade" required>
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <!-- [ì¶”ê°€ ê¸°ëŠ¥] í•™ë…„ ì œí•œ 4~6í•™ë…„ -->
                <option value="4">4í•™ë…„</option>
                <option value="5">5í•™ë…„</option>
                <option value="6">6í•™ë…„</option>
              </select>
            </div>

            <div class="form-group">
              <label for="classNumber">ë°˜</label>
              <select id="classNumber" name="classNumber" required>
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">1ë°˜</option>
                <option value="2">2ë°˜</option>
                <option value="3">3ë°˜</option>
                <option value="4">4ë°˜</option>
                <option value="5">5ë°˜</option>
                <option value="6">6ë°˜</option>
                <option value="7">7ë°˜</option>
                <option value="8">8ë°˜</option>
                <option value="9">9ë°˜</option>
                <option value="10">10ë°˜</option>
              </select>
            </div>

            <div class="form-group">
              <label for="studentNumber">ë²ˆí˜¸</label>
              <input
                type="number"
                id="studentNumber"
                name="studentNumber"
                min="1"
                max="40"
                placeholder="í•™ë²ˆ"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="studentName">ì´ë¦„</label>
            <input
              type="text"
              id="studentName"
              name="studentName"
              placeholder="í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>

          <button
            type="submit"
            class="register-button"
            id="registerBtn"
            disabled
          >
            í•™ìŠµ ì‹œì‘í•˜ê¸° ğŸš€
          </button>
        </form>

        <div class="existing-student">
          <p><strong>ì´ë¯¸ ë“±ë¡ëœ í•™ìƒì´ì‹ ê°€ìš”?</strong></p>
          <p style="font-size: 12px; color: #666; margin: 5px 0">
            í•™ê¸‰ ì½”ë“œ + ì´ë¦„ìœ¼ë¡œ ë¡œê·¸ì¸
          </p>
          <button type="button" id="existingStudentBtn">
            ê¸°ì¡´ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
          </button>

          <div style="margin: 20px 0; text-align: center">
            <hr style="margin: 15px 0" />
            <p>ë˜ëŠ”</p>
          </div>

          <p><strong>ì²˜ìŒ ë“±ë¡í•˜ì‹œë‚˜ìš”?</strong></p>
          <p style="font-size: 12px; color: #666; margin: 5px 0">
            ì„ ìƒë‹˜ì´ ì•Œë ¤ì¤€ í•™ê¸‰ ì½”ë“œë¡œ ê°„í¸ ë“±ë¡
          </p>
          <button type="button" id="classCodeBtn" style="background: #ff9800">
            í•™ê¸‰ ì½”ë“œë¡œ ë“±ë¡
          </button>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script>
      // [ì¶”ê°€ ê¸°ëŠ¥] ì§€ì—­/í•™êµ JSON ë¡œë“œ ë° ë°”ì¸ë”©
      let SCHOOL_DATA = [];
      const regionSelect = document.getElementById("regionSelect");
      const schoolSelect = document.getElementById("schoolSelect");
      const schoolCodeInput = document.getElementById("schoolCode");
      const registerBtn = document.getElementById("registerBtn");

      async function loadSchools() {
        try {
          const res = await fetch("/api/schools-map");
          const payload = await res.json();
          if (!payload.success || !Array.isArray(payload.regions))
            throw new Error("í˜•ì‹ ì˜¤ë¥˜");
          SCHOOL_DATA = payload.regions;
          regionSelect.innerHTML =
            '<option value="">ì„ íƒ</option>' +
            SCHOOL_DATA.map(
              (r) =>
                `<option value="${r.region_code}">${r.region_name}</option>`
            ).join("");
        } catch (e) {
          alert("í•™êµ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: JSON íŒŒì‹± ì‹¤íŒ¨ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
        }
      }

      regionSelect.addEventListener("change", () => {
        schoolCodeInput.value = "";
        registerBtn.disabled = true;
        const code = regionSelect.value;
        const region = SCHOOL_DATA.find((r) => r.region_code === code);
        if (!region) {
          schoolSelect.innerHTML = '<option value="">ì…ë ¥í•´ì£¼ì„¸ìš”</option>';
          schoolSelect.disabled = true;
          return;
        }
        schoolSelect.disabled = false;
        schoolSelect.innerHTML =
          '<option value="">ì„ íƒ</option>' +
          region.schools
            .map(
              (s) =>
                `<option value="${s.school_code}">${s.school_name}</option>`
            )
            .join("");
      });

      schoolSelect.addEventListener("change", () => {
        const code = schoolSelect.value;
        if (!code) {
          schoolCodeInput.value = "";
          registerBtn.disabled = true;
          return;
        }
        schoolCodeInput.value = code;
        registerBtn.disabled = false;
      });

      // DOM ready ì‹œ ë¡œë“œ
      document.addEventListener("DOMContentLoaded", loadSchools);

      document
        .getElementById("registerForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          registerBtn.disabled = true;
          registerBtn.textContent = "ë“±ë¡ ì¤‘...";

          try {
            const formData = new FormData(e.target);
            const studentInfo = {
              schoolName: formData.get("schoolName"),
              grade: parseInt(formData.get("grade")),
              classNumber: parseInt(formData.get("classNumber")),
              studentNumber: parseInt(formData.get("studentNumber")),
              studentName: formData.get("studentName"),
              school_code: schoolCodeInput.value, // [ì¶”ê°€ ê¸°ëŠ¥]
            };

            if (!schoolCodeInput.value) {
              alert("í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (í•™êµ ì½”ë“œ ëˆ„ë½)");
              registerBtn.disabled = false;
              registerBtn.textContent = "í•™ìŠµ ì‹œì‘í•˜ê¸° ğŸš€";
              return;
            }

            // í•™ìƒ ë“±ë¡ API í˜¸ì¶œ
            const response = await fetch("/api/student/register", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(studentInfo),
            });

            const data = await response.json();

            if (data.success) {
              // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— í•™ìƒ ID ì €ì¥
              localStorage.setItem("studentId", data.student.id);
              localStorage.setItem("studentInfo", JSON.stringify(data.student));

              // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
              alert(
                `${studentInfo.studentName}ë‹˜, ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\ní•™ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ‰`
              );
              window.location.href = "index.html";
            } else {
              alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
            }
          } catch (error) {
            console.error("ë“±ë¡ ì˜¤ë¥˜:", error);
            alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          } finally {
            registerBtn.disabled = false;
            registerBtn.textContent = "í•™ìŠµ ì‹œì‘í•˜ê¸° ğŸš€";
          }
        });

      document
        .getElementById("existingStudentBtn")
        .addEventListener("click", async function () {
          // 1ë‹¨ê³„: í•™ê¸‰ ì½”ë“œ ì…ë ¥
          const classCode = prompt("ì„ ìƒë‹˜ì´ ì•Œë ¤ì¤€ í•™ê¸‰ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
          if (!classCode) return;

          // 2ë‹¨ê³„: í•™ìƒ ì´ë¦„ ì…ë ¥
          const studentName = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
          if (!studentName) return;

          try {
            // í•™ê¸‰ ì½”ë“œ + ì´ë¦„ìœ¼ë¡œ í•™ìƒ ê²€ìƒ‰
            const response = await fetch("/api/student/search-by-class", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                classCode: classCode,
                studentName: studentName,
              }),
            });

            const data = await response.json();

            if (data.success && data.students.length > 0) {
              if (data.students.length === 1) {
                // 1ëª…ë§Œ ìˆìœ¼ë©´ ë°”ë¡œ ë¡œê·¸ì¸
                const student = data.students[0];
                localStorage.setItem("studentId", student.id);
                localStorage.setItem("studentInfo", JSON.stringify(student));
                alert(
                  `${student.studentName}ë‹˜ (${student.schoolName} ${student.grade}í•™ë…„ ${student.classNumber}ë°˜ ${student.studentNumber}ë²ˆ)ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.`
                );
                window.location.href = "index.html";
              } else {
                // ê°™ì€ í•™ê¸‰ ë‚´ ë™ëª…ì´ì¸ì´ ìˆì„ ê²½ìš°
                let message = `${data.classInfo.schoolName} ${data.classInfo.grade}í•™ë…„ ${data.classInfo.classNumber}ë°˜ì—ì„œ "${studentName}" ì´ë¦„ì˜ í•™ìƒì´ ${data.students.length}ëª… ìˆìŠµë‹ˆë‹¤:\n\n`;
                data.students.forEach((student, index) => {
                  message += `${index + 1}. ${student.studentName} (${
                    student.studentNumber
                  }ë²ˆ)\n`;
                });
                message += "\nëª‡ ë²ˆì„ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

                const choice = prompt(message);
                const choiceIndex = parseInt(choice) - 1;

                if (choiceIndex >= 0 && choiceIndex < data.students.length) {
                  const selectedStudent = data.students[choiceIndex];
                  localStorage.setItem("studentId", selectedStudent.id);
                  localStorage.setItem(
                    "studentInfo",
                    JSON.stringify(selectedStudent)
                  );
                  alert(
                    `${selectedStudent.studentName}ë‹˜ (${selectedStudent.studentNumber}ë²ˆ)ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.`
                  );
                  window.location.href = "index.html";
                }
              }
            } else if (data.error === "ìœ íš¨í•˜ì§€ ì•Šì€ í•™ê¸‰ ì½”ë“œì…ë‹ˆë‹¤.") {
              alert(
                "í•™ê¸‰ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì„ ìƒë‹˜ê»˜ ì •í™•í•œ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              );
            } else {
              alert(
                `í•´ë‹¹ í•™ê¸‰ì—ì„œ "${studentName}" ì´ë¦„ì˜ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`
              );
            }
          } catch (error) {
            console.error("í•™ìƒ ê²€ìƒ‰ ì˜¤ë¥˜:", error);
            alert("í•™ìƒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });

      // í•™ê¸‰ ì½”ë“œë¡œ ë“±ë¡
      document
        .getElementById("classCodeBtn")
        .addEventListener("click", async function () {
          const classCode = prompt("ì„ ìƒë‹˜ì´ ì•Œë ¤ì¤€ í•™ê¸‰ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
          if (!classCode) return;

          const studentName = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
          if (!studentName) return;

          const studentNumber = prompt("í•™ìƒ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
          if (!studentNumber) return;

          try {
            const response = await fetch("/api/student/register-with-code", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                classCode: classCode,
                studentName: studentName,
                studentNumber: parseInt(studentNumber),
              }),
            });

            const data = await response.json();

            if (data.success) {
              localStorage.setItem("studentId", data.student.id);
              localStorage.setItem("studentInfo", JSON.stringify(data.student));
              alert(
                `${data.student.studentName}ë‹˜, ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n${data.student.schoolName} ${data.student.grade}í•™ë…„ ${data.student.classNumber}ë°˜ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`
              );
              window.location.href = "index.html";
            } else {
              alert("ë“±ë¡ ì‹¤íŒ¨: " + data.error);
            }
          } catch (error) {
            console.error("í•™ê¸‰ ì½”ë“œ ë“±ë¡ ì˜¤ë¥˜:", error);
            alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });

      // ì´ë¯¸ ë“±ë¡ëœ í•™ìƒì¸ì§€ í™•ì¸
      document.addEventListener("DOMContentLoaded", function () {
        const existingStudentId = localStorage.getItem("studentId");
        if (existingStudentId) {
          if (
            confirm(
              "ì´ë¯¸ ë“±ë¡ëœ í•™ìƒ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
            )
          ) {
            window.location.href = "index.html";
          }
        }
      });

      // [ì¶”ê°€ ê¸°ëŠ¥] í•™êµëª… typeahead (ê³µê°œ API)
      (function initSchoolTypeahead() {
        const input = document.getElementById("schoolName");
        const dl = document.getElementById("schoolList");
        let lastQ = "";
        input.addEventListener("input", async () => {
          const q = input.value.trim();
          if (q.length < 2 || q === lastQ) return;
          lastQ = q;
          try {
            const r = await fetch(`/api/schools?q=${encodeURIComponent(q)}`);
            if (!r.ok) return;
            const data = await r.json();
            dl.innerHTML = "";
            (data.schools || []).forEach((name) => {
              const opt = document.createElement("option");
              opt.value = name;
              dl.appendChild(opt);
            });
          } catch (e) {}
        });
      })();
    </script>
  </body>
</html>
