<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í•™ìƒ ë“±ë¡ - í°ìˆ˜í•™ìŠµ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .register-container {
        max-width: 500px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .register-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-group label {
        font-weight: bold;
        color: #333;
        font-size: 16px;
      }

      .form-group input,
      .form-group select {
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
      }

      .register-button {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .register-button:hover {
        transform: translateY(-2px);
      }

      .register-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .form-row {
        display: flex;
        gap: 15px;
      }

      .form-row .form-group {
        flex: 1;
      }

      .welcome-message {
        text-align: center;
        margin-bottom: 30px;
      }

      .welcome-message h1 {
        color: #4caf50;
        margin-bottom: 10px;
      }

      .welcome-message p {
        color: #666;
        font-size: 16px;
      }

      .existing-student {
        text-align: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .existing-student button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="register-container">
        <div class="welcome-message">
          <h1>ğŸ« í°ìˆ˜í•™ìŠµ ì‹œì‘í•˜ê¸°</h1>
          <p>í•™ìŠµì„ ì‹œì‘í•˜ê¸° ì „ì— í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
        </div>

        <form class="register-form" id="registerForm">
          <div class="form-group">
            <label for="schoolName">í•™êµëª…</label>
            <input
              type="text"
              id="schoolName"
              name="schoolName"
              placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="grade">í•™ë…„</label>
              <select id="grade" name="grade" required>
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">1í•™ë…„</option>
                <option value="2">2í•™ë…„</option>
                <option value="3">3í•™ë…„</option>
                <option value="4">4í•™ë…„</option>
                <option value="5">5í•™ë…„</option>
                <option value="6">6í•™ë…„</option>
              </select>
            </div>

            <div class="form-group">
              <label for="classNumber">ë°˜</label>
              <select id="classNumber" name="classNumber" required>
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">1ë°˜</option>
                <option value="2">2ë°˜</option>
                <option value="3">3ë°˜</option>
                <option value="4">4ë°˜</option>
                <option value="5">5ë°˜</option>
                <option value="6">6ë°˜</option>
                <option value="7">7ë°˜</option>
                <option value="8">8ë°˜</option>
                <option value="9">9ë°˜</option>
                <option value="10">10ë°˜</option>
              </select>
            </div>

            <div class="form-group">
              <label for="studentNumber">ë²ˆí˜¸</label>
              <input
                type="number"
                id="studentNumber"
                name="studentNumber"
                min="1"
                max="40"
                placeholder="í•™ë²ˆ"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="studentName">ì´ë¦„</label>
            <input
              type="text"
              id="studentName"
              name="studentName"
              placeholder="í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>

          <button type="submit" class="register-button" id="registerBtn">
            í•™ìŠµ ì‹œì‘í•˜ê¸° ğŸš€
          </button>
        </form>

        <div class="existing-student">
          <p>ì´ë¯¸ ë“±ë¡ëœ í•™ìƒì´ì‹ ê°€ìš”?</p>
          <button type="button" id="existingStudentBtn">
            ê¸°ì¡´ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
          </button>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script>
      document
        .getElementById("registerForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const registerBtn = document.getElementById("registerBtn");
          registerBtn.disabled = true;
          registerBtn.textContent = "ë“±ë¡ ì¤‘...";

          try {
            const formData = new FormData(e.target);
            const studentInfo = {
              schoolName: formData.get("schoolName"),
              grade: parseInt(formData.get("grade")),
              classNumber: parseInt(formData.get("classNumber")),
              studentNumber: parseInt(formData.get("studentNumber")),
              studentName: formData.get("studentName"),
            };

            // í•™ìƒ ë“±ë¡ API í˜¸ì¶œ
            const response = await fetch("/api/student/register", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(studentInfo),
            });

            const data = await response.json();

            if (data.success) {
              // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— í•™ìƒ ID ì €ì¥
              localStorage.setItem("studentId", data.student.id);
              localStorage.setItem("studentInfo", JSON.stringify(data.student));

              // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
              alert(
                `${studentInfo.studentName}ë‹˜, ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\ní•™ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ‰`
              );
              window.location.href = "index.html";
            } else {
              alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
            }
          } catch (error) {
            console.error("ë“±ë¡ ì˜¤ë¥˜:", error);
            alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          } finally {
            registerBtn.disabled = false;
            registerBtn.textContent = "í•™ìŠµ ì‹œì‘í•˜ê¸° ğŸš€";
          }
        });

      document
        .getElementById("existingStudentBtn")
        .addEventListener("click", async function () {
          const studentName = prompt("ë“±ë¡ëœ í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
          if (!studentName) return;

          try {
            // ì´ë¦„ìœ¼ë¡œ í•™ìƒ ê²€ìƒ‰
            const response = await fetch("/api/student/search", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ studentName: studentName }),
            });

            const data = await response.json();

            if (data.success && data.students.length > 0) {
              if (data.students.length === 1) {
                // 1ëª…ë§Œ ìˆìœ¼ë©´ ë°”ë¡œ ë¡œê·¸ì¸
                const student = data.students[0];
                localStorage.setItem("studentId", student.id);
                localStorage.setItem("studentInfo", JSON.stringify(student));
                alert(
                  `${student.studentName}ë‹˜ (${student.schoolName} ${student.grade}í•™ë…„ ${student.classNumber}ë°˜ ${student.studentNumber}ë²ˆ)ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.`
                );
                window.location.href = "index.html";
              } else {
                // ì—¬ëŸ¬ ëª…ì´ë©´ ì„ íƒí•˜ê²Œ í•¨
                let message = `"${studentName}" ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ í•™ìƒì´ ${data.students.length}ëª… ìˆìŠµë‹ˆë‹¤:\n\n`;
                data.students.forEach((student, index) => {
                  message += `${index + 1}. ${student.studentName} (${
                    student.schoolName
                  } ${student.grade}í•™ë…„ ${student.classNumber}ë°˜ ${
                    student.studentNumber
                  }ë²ˆ)\n`;
                });
                message += "\nëª‡ ë²ˆì„ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

                const choice = prompt(message);
                const choiceIndex = parseInt(choice) - 1;

                if (choiceIndex >= 0 && choiceIndex < data.students.length) {
                  const selectedStudent = data.students[choiceIndex];
                  localStorage.setItem("studentId", selectedStudent.id);
                  localStorage.setItem(
                    "studentInfo",
                    JSON.stringify(selectedStudent)
                  );
                  alert(`${selectedStudent.studentName}ë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.`);
                  window.location.href = "index.html";
                }
              }
            } else {
              alert(
                `"${studentName}" ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìƒˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.`
              );
            }
          } catch (error) {
            console.error("í•™ìƒ ê²€ìƒ‰ ì˜¤ë¥˜:", error);
            alert("í•™ìƒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });

      // ì´ë¯¸ ë“±ë¡ëœ í•™ìƒì¸ì§€ í™•ì¸
      document.addEventListener("DOMContentLoaded", function () {
        const existingStudentId = localStorage.getItem("studentId");
        if (existingStudentId) {
          if (
            confirm(
              "ì´ë¯¸ ë“±ë¡ëœ í•™ìƒ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
            )
          ) {
            window.location.href = "index.html";
          }
        }
      });
    </script>
  </body>
</html>
