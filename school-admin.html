<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ - í°ìˆ˜í•™ìŠµ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .admin-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
      }

      .admin-header {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 30px;
      }

      .admin-sections {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .admin-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid #e3f2fd;
      }

      .section-title {
        color: #1976d2;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .school-code-display {
        background: #f8f9fa;
        border: 2px dashed #4caf50;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin: 15px 0;
      }

      .school-code {
        font-size: 24px;
        font-weight: bold;
        color: #2e7d32;
        font-family: "Courier New", monospace;
        letter-spacing: 2px;
      }

      .students-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .students-table th,
      .students-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .students-table th {
        background: #f5f5f5;
        font-weight: bold;
        color: #333;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .btn-primary {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
      }

      .btn-primary:hover {
        background: #45a049;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat-card {
        background: linear-gradient(135deg, #e3f2fd, #f1f8e9);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        border: 2px solid #4caf50;
      }

      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #2e7d32;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .copy-button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
      }

      @media (max-width: 768px) {
        .admin-sections {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* [ì¶”ê°€ ê¸°ëŠ¥] ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
      .login-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .login-card {
        background: #ffffff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 360px;
        border: 2px solid #e3f2fd;
      }
      .login-card h2 {
        margin: 0 0 12px 0;
        font-size: 18px;
        color: #1976d2;
      }
      .login-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin: 8px 0 12px 0;
      }

      /* [ì¶”ê°€ ê¸°ëŠ¥] ì¦‰ì‹œ ê°œì… íŒ¨ë„ */
      .interventions-panel {
        background: #fff8e1;
        border: 2px solid #ffe082;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
      }
      .intervention-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 8px 10px;
        border-bottom: 1px dashed #ffecb3;
      }
      .intervention-item:last-child {
        border-bottom: none;
      }
      .badge-reason {
        background: #ff9800;
        color: #fff;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
      }
      .btn-linkcopy {
        background: #9c27b0;
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }

      /* [ì¶”ê°€ ê¸°ëŠ¥] QR ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
      .qr-area {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 12px;
        align-items: center;
      }
      .qr-img {
        width: 120px;
        height: 120px;
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 8px;
        object-fit: contain;
      }
      .qr-tools {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .short-url-row {
        display: flex;
        gap: 8px;
      }
      .short-url-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      /* [ì¶”ê°€ ê¸°ëŠ¥] íˆíŠ¸ë§µ */
      .heatmap-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      .heatmap-table th,
      .heatmap-table td {
        border: 1px solid #e0e0e0;
        padding: 8px;
        text-align: center;
        font-size: 12px;
      }
      .heatmap-table th {
        background: #f5f5f5;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .heatmap-cell {
        position: relative;
        border-radius: 6px;
      }
      .heatmap-cell .rate-label {
        position: relative;
        z-index: 2;
        font-weight: bold;
        color: #1a237e;
      }
      .heatmap-legend {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
      }

      /* [ì¶”ê°€ ê¸°ëŠ¥] í† ìŠ¤íŠ¸ */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 12px;
        display: none;
        z-index: 2000;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="admin-container">
        <!-- [ì¶”ê°€ ê¸°ëŠ¥] ì¦‰ì‹œ ê°œì… íŒ¨ë„ -->
        <div
          class="interventions-panel"
          id="interventionsPanel"
          aria-label="ì¦‰ì‹œ ê°œì… ì•Œë¦¼"
        >
          <div class="section-title" style="margin-top: 0">ğŸ”” ì¦‰ì‹œ ê°œì…</div>
          <div
            id="interventionsList"
            aria-live="polite"
            aria-busy="false"
            style="max-height: 180px; overflow: auto"
          >
            <div style="color: #8d6e63; font-size: 14px">
              ìµœê·¼ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>
        <div class="admin-header">
          <h1>ğŸ‘©â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€</h1>
          <p>í•™ê¸‰ ê´€ë¦¬ ë° í•™ìƒ ì§„ë„ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="admin-sections">
          <div class="admin-section">
            <div class="section-title">ğŸ« í•™êµ ì •ë³´ ì„¤ì •</div>

            <div class="form-group">
              <label>í•™êµëª…</label>
              <div class="search-container" style="position: relative">
                <input
                  type="text"
                  id="schoolName"
                  placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ, ë¶€ì‚°ì´ˆë“±í•™êµ)"
                  aria-label="í•™êµëª… ê²€ìƒ‰"
                  autocomplete="off"
                  style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 16px;
                  "
                />
                <div
                  id="schoolDropdown"
                  class="school-dropdown"
                  style="
                    display: none;
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 2px solid #4caf50;
                    border-top: none;
                    border-radius: 0 0 8px 8px;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                  "
                ></div>
              </div>
              <div
                id="schoolSearchHint"
                style="font-size: 12px; color: #666; margin-top: 5px"
              >
                ğŸ’¡ í•™êµëª…ì˜ ì¼ë¶€ë§Œ ì…ë ¥í•´ë„ ê²€ìƒ‰ë©ë‹ˆë‹¤ (ìµœì†Œ 2ê¸€ì)
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>í•™ë…„</label>
                <select id="grade">
                  <option value="">ì„ íƒ</option>
                  <!-- [ì¶”ê°€ ê¸°ëŠ¥] í•™ë…„ ì œí•œ 4~6í•™ë…„ -->
                  <option value="4">4í•™ë…„</option>
                  <option value="5">5í•™ë…„</option>
                  <option value="6">6í•™ë…„</option>
                </select>
              </div>
              <div class="form-group">
                <label>ë°˜</label>
                <select id="classNumber">
                  <option value="">ì„ íƒ</option>
                  <option value="1">1ë°˜</option>
                  <option value="2">2ë°˜</option>
                  <option value="3">3ë°˜</option>
                  <option value="4">4ë°˜</option>
                  <option value="5">5ë°˜</option>
                  <option value="6">6ë°˜</option>
                  <option value="7">7ë°˜</option>
                  <option value="8">8ë°˜</option>
                  <option value="9">9ë°˜</option>
                  <option value="10">10ë°˜</option>
                </select>
              </div>
            </div>

            <button class="btn-primary" id="generateCodeBtn">
              í•™ê¸‰ ì½”ë“œ ìƒì„±
            </button>

            <!-- [ì¶”ê°€ ê¸°ëŠ¥] í•™ê¸‰ PIN ì…ë ¥ -->
            <div class="form-group" style="margin-top: 10px">
              <label>í•™ê¸‰ PIN(6ìë¦¬, ê´€ë¦¬ìë§Œ ë³´ì„)</label>
              <input
                type="password"
                id="classPin"
                maxlength="6"
                class="login-input"
                aria-label="í•™ê¸‰ PIN ì…ë ¥"
                placeholder="ì˜ˆ: 123456"
              />
            </div>

            <div
              id="schoolCodeDisplay"
              class="school-code-display"
              style="display: none"
            >
              <div>ğŸ“‹ í•™ìƒ ë“±ë¡ ì½”ë“œ</div>
              <div class="school-code" id="schoolCode"></div>
              <button class="copy-button" id="copyCodeBtn">ì½”ë“œ ë³µì‚¬</button>
              <!-- [ì¶”ê°€ ê¸°ëŠ¥] QR/ì§§ì€ URL -->
              <div class="qr-area" id="qrArea" style="display: none">
                <img id="qrImg" alt="í•™ê¸‰ ë“±ë¡ QR ì½”ë“œ" class="qr-img" />
                <div class="qr-tools">
                  <div class="short-url-row">
                    <input
                      id="shortUrl"
                      class="short-url-input"
                      aria-label="ì§§ì€ URL"
                      readonly
                    />
                    <button class="btn-secondary" id="copyShortUrlBtn">
                      URL ë³µì‚¬
                    </button>
                  </div>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap">
                    <button class="btn-secondary" id="downloadPngBtn">
                      QR PNG ë‹¤ìš´ë¡œë“œ
                    </button>
                    <label style="font-size: 12px; color: #666"
                      >ìœ íš¨ê¸°ê°„(ì¼):
                      <input
                        id="qrDays"
                        type="number"
                        min="1"
                        max="30"
                        value="7"
                        style="width: 64px; margin-left: 6px"
                        aria-label="QR ìœ íš¨ê¸°ê°„(ì¼)"
                      />
                    </label>
                  </div>
                </div>
              </div>
              <div style="margin-top: 15px; font-size: 14px; color: #666">
                í•™ìƒë“¤ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!<br />
                ë“±ë¡í•  ë•Œ "í•™ê¸‰ ì½”ë“œë¡œ ë“±ë¡" ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>

          <div class="admin-section">
            <div class="section-title">ğŸ“Š í•™ê¸‰ í˜„í™©</div>

            <div class="stats-grid" id="statsGrid">
              <div class="stat-card">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">ì „ì²´ í•™ìƒ</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="completedStudents">0</div>
                <div class="stat-label">ì™„ë£Œ í•™ìƒ</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="averageProgress">0%</div>
                <div class="stat-label">í‰ê·  ì§„ë„</div>
              </div>
            </div>

            <button class="btn-secondary" id="refreshBtn">í˜„í™© ìƒˆë¡œê³ ì¹¨</button>

            <!-- [ì¶”ê°€ ê¸°ëŠ¥] íˆíŠ¸ë§µ -->
            <div style="margin-top: 20px">
              <div class="section-title" style="gap: 6px">
                ğŸ”¥ ì˜¤ë¥˜íƒœê·¸ íˆíŠ¸ë§µ
                <span style="font-size: 12px; color: #666; font-weight: normal"
                  >(í–‰=ë‹¨ê³„, ì—´=ì˜¤ë¥˜íƒœê·¸)</span
                >
              </div>
              <div style="font-size: 12px; color: #666">
                â€¢ ì´ íˆíŠ¸ë§µì€
                <b>ì˜¤ê°œë…(ì˜¤ë¥˜íƒœê·¸) ê¸°ë°˜ì˜ í˜•ì„±í‰ê°€ ë„êµ¬</b>ì…ë‹ˆë‹¤. ì„±ì·¨ê¸°ì¤€ì€
                ë³´ì¡°ì ìœ¼ë¡œ ì°¸ì¡°í•˜ì„¸ìš”.<br />
                â€¢ ìƒ‰ ê°•ë„ëŠ” <b>ì˜¤ë¥˜ ë°œìƒë¥ (%)</b>ì„ ì˜ë¯¸í•˜ë©°, ìˆ˜ì¹˜ë„ í•¨ê»˜
                ì œê³µí•©ë‹ˆë‹¤.<br />
                â€¢ ì´ ì§€í‘œëŠ” ê°œì¸ì˜ ê³ ì •ëœ ëŠ¥ë ¥ì´ ì•„ë‹ˆë¼
                <b>ì§€ê¸ˆ ê°œì…ì´ í•„ìš”í•œ ì˜ì—­</b>ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
              </div>
              <div style="overflow: auto">
                <table
                  class="heatmap-table"
                  id="heatmapTable"
                  aria-label="í•™ê¸‰ ì˜¤ë¥˜íƒœê·¸ íˆíŠ¸ë§µ"
                ></table>
              </div>
              <div class="heatmap-legend">
                ì§„í•œ ìƒ‰ = ë†’ì€ ë°œìƒë¥ , ê° ì…€ì— % í‘œì‹œ
              </div>
            </div>
          </div>
        </div>

        <div class="admin-section">
          <div class="section-title">ğŸ‘¥ í•™ìƒ ëª©ë¡ ë° ì§„ë„</div>

          <table class="students-table" id="studentsTable">
            <thead>
              <tr>
                <th>ë²ˆí˜¸</th>
                <th>ì´ë¦„</th>
                <th>ì§„ë„</th>
                <th>ì™„ë£Œìœ¨</th>
                <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
              </tr>
            </thead>
            <tbody id="studentsTableBody">
              <tr>
                <td colspan="5" style="text-align: center; color: #666">
                  í•™ê¸‰ ì½”ë“œë¥¼ ìƒì„±í•˜ê³  í˜„í™©ì„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- [ì¶”ê°€ ê¸°ëŠ¥] ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
    <div
      class="login-overlay"
      id="loginOverlay"
      role="dialog"
      aria-modal="true"
      aria-label="ê´€ë¦¬ì ë¡œê·¸ì¸"
    >
      <div class="login-card">
        <!-- 1ë‹¨ê³„: êµì‚¬ ì½”ë“œ ì…ë ¥ -->
        <div id="teacherCodeStep">
          <h2>êµì‚¬ ì¸ì¦</h2>
          <label for="teacherCodeInput" style="font-size: 12px; color: #555"
            >êµì‚¬ ì½”ë“œ (êµìœ¡ì²­ ë°°í¬)</label
          >
          <input
            type="text"
            id="teacherCodeInput"
            class="login-input"
            placeholder="ì˜ˆ: SEOUL_EDU_2024"
            maxlength="30"
          />
          <button class="btn-primary" id="verifyTeacherCodeBtn">
            êµì‚¬ ì½”ë“œ ì¸ì¦
          </button>
          <div
            style="
              font-size: 11px;
              color: #666;
              margin-top: 8px;
              line-height: 1.4;
            "
          >
            ğŸ’¡ ê° ì§€ì—­ êµìœ¡ì²­ì—ì„œ ë°°í¬í•œ êµì‚¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br />
            ğŸ“ ì½”ë“œë¥¼ ëª¨ë¥´ì‹œë©´ êµìœ¡ì²­ì— ë¬¸ì˜í•˜ì„¸ìš”.
          </div>
        </div>

        <!-- 2ë‹¨ê³„: í•™ê¸‰ ì½”ë“œ ë¡œê·¸ì¸ (ìˆ¨ê¹€) -->
        <div id="classLoginStep" style="display: none">
          <h2>êµì‚¬ ë¡œê·¸ì¸</h2>
          <div
            style="font-size: 12px; color: #4caf50; margin-bottom: 10px"
            id="regionInfo"
          ></div>
          <label for="adminClassCode" style="font-size: 12px; color: #555"
            >í•™ê¸‰ ì½”ë“œ</label
          >
          <input
            type="text"
            id="adminClassCode"
            class="login-input"
            placeholder="ì˜ˆ: ì„œìš¸501ABCD"
            maxlength="20"
          />
          <label for="adminPin" style="font-size: 12px; color: #555"
            >PIN (6ìë¦¬ ìˆ«ì)</label
          >
          <input
            type="password"
            id="adminPin"
            class="login-input"
            placeholder="123456"
            maxlength="6"
            pattern="[0-9]{6}"
          />
          <button class="btn-primary" id="loginBtn">ë¡œê·¸ì¸</button>
          <div
            style="
              font-size: 11px;
              color: #666;
              margin-top: 8px;
              line-height: 1.4;
            "
          >
            ğŸ’¡ í•™ê¸‰ ì½”ë“œ ìƒì„± í›„ ë°›ì€ ì½”ë“œì™€ ì„¤ì •í•œ PINì„ ì…ë ¥í•˜ì„¸ìš”.<br />
            âš ï¸ ì½”ë“œì™€ PINì„ ë¶„ì‹¤í•˜ë©´ ìƒˆë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
          </div>
          <button
            type="button"
            id="backToTeacherCodeBtn"
            style="background: #666; margin-top: 10px"
          >
            â† êµì‚¬ ì½”ë“œ ë‹¤ì‹œ ì…ë ¥
          </button>
        </div>

        <div
          id="loginMsg"
          style="font-size: 12px; color: #c62828; margin-top: 6px"
        ></div>
      </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script src="config.js"></script>
    <script>
      let currentSchoolCode = null;
      let currentClassInfo = null;
      let currentPin = null; // [ì¶”ê°€ ê¸°ëŠ¥]
      let demoMode = false; // [ì¶”ê°€ ê¸°ëŠ¥]

      // [ê°œì„ ëœ ê¸°ëŠ¥] 2ë‹¨ê³„ êµì‚¬ ì¸ì¦ ì‹œìŠ¤í…œ
      let currentTeacherAuth = { classCode: null, pin: null };
      let currentTeacherCode = null;

      async function ensureTeacherSession() {
        // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
        if (currentTeacherAuth.classCode && currentTeacherAuth.pin) {
          try {
            const r = await fetch(
              `/api/admin/session?classCode=${encodeURIComponent(
                currentTeacherAuth.classCode
              )}&pin=${encodeURIComponent(currentTeacherAuth.pin)}`
            );
            if (r.ok) {
              document.getElementById("loginOverlay").style.display = "none";
              return true;
            }
          } catch (e) {}
        }

        // ë¡œê·¸ì¸ í•„ìš” - 1ë‹¨ê³„ë¶€í„° ì‹œì‘
        document.getElementById("teacherCodeStep").style.display = "block";
        document.getElementById("classLoginStep").style.display = "none";
        document.getElementById("loginOverlay").style.display = "flex";
        return false;
      }

      // 1ë‹¨ê³„: êµì‚¬ ì½”ë“œ ì¸ì¦
      document
        .getElementById("verifyTeacherCodeBtn")
        .addEventListener("click", async () => {
          const teacherCode = document
            .getElementById("teacherCodeInput")
            .value.trim();

          if (!teacherCode) {
            document.getElementById("loginMsg").textContent =
              "êµì‚¬ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”";
            return;
          }

          try {
            const r = await fetch("/api/admin/verify-teacher-code", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ teacherCode: teacherCode }),
            });

            const data = await r.json();

            if (r.ok && data.success) {
              currentTeacherCode = teacherCode;
              document.getElementById("teacherCodeStep").style.display = "none";
              document.getElementById("classLoginStep").style.display = "block";
              document.getElementById(
                "regionInfo"
              ).textContent = `âœ… ${data.regionName} êµì‚¬ ì¸ì¦ ì™„ë£Œ`;
              document.getElementById("loginMsg").textContent = "";
              showToast(`êµì‚¬ ì¸ì¦ ì„±ê³µ: ${data.regionName}`);
            } else {
              document.getElementById("loginMsg").textContent =
                data.error || "êµì‚¬ ì½”ë“œ ì¸ì¦ ì‹¤íŒ¨";
            }
          } catch (e) {
            document.getElementById("loginMsg").textContent = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
          }
        });

      // ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼
      document
        .getElementById("backToTeacherCodeBtn")
        .addEventListener("click", () => {
          document.getElementById("teacherCodeStep").style.display = "block";
          document.getElementById("classLoginStep").style.display = "none";
          document.getElementById("loginMsg").textContent = "";
        });

      // 2ë‹¨ê³„: í•™ê¸‰ ì½”ë“œ ë¡œê·¸ì¸
      document
        .getElementById("loginBtn")
        .addEventListener("click", async () => {
          const classCode = document
            .getElementById("adminClassCode")
            .value.trim();
          const pin = document.getElementById("adminPin").value.trim();

          if (!classCode || !pin) {
            document.getElementById("loginMsg").textContent =
              "í•™ê¸‰ ì½”ë“œì™€ PINì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”";
            return;
          }

          try {
            const r = await fetch("/api/admin/teacher-login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ classCode: classCode, pin: pin }),
            });

            const data = await r.json();

            if (r.ok && data.success) {
              currentTeacherAuth = { classCode: classCode, pin: pin };
              document.getElementById("loginOverlay").style.display = "none";
              showToast(
                `ë¡œê·¸ì¸ ì„±ê³µ: ${data.classInfo.schoolName} ${data.classInfo.grade}í•™ë…„ ${data.classInfo.classNumber}ë°˜`
              );

              // í•™ê¸‰ ì •ë³´ ìë™ ì…ë ¥
              document.getElementById("schoolName").value =
                data.classInfo.schoolName;
              document.getElementById("grade").value = data.classInfo.grade;
              document.getElementById("classNumber").value =
                data.classInfo.classNumber;
              document.getElementById("classPin").value = pin;
            } else {
              document.getElementById("loginMsg").textContent =
                data.error || "ë¡œê·¸ì¸ ì‹¤íŒ¨";
            }
          } catch (e) {
            document.getElementById("loginMsg").textContent = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
          }
        });

      // [ì¶”ê°€ ê¸°ëŠ¥] URL íŒŒë¼ë¯¸í„°ë¡œ demo ëª¨ë“œ
      try {
        const usp = new URLSearchParams(location.search);
        demoMode = usp.get("demo") === "1";
      } catch (e) {}

      // í•™ê¸‰ ì½”ë“œ ìƒì„±
      document
        .getElementById("generateCodeBtn")
        .addEventListener("click", async function () {
          const schoolName = document.getElementById("schoolName").value;
          const grade = document.getElementById("grade").value;
          const classNumber = document.getElementById("classNumber").value;
          currentPin = (document.getElementById("classPin").value || "").trim(); // [ì¶”ê°€ ê¸°ëŠ¥]

          if (!schoolName || !grade || !classNumber) {
            alert("í•™êµëª…, í•™ë…„, ë°˜ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          // í•™ê¸‰ ì½”ë“œ ìƒì„± (í•™êµëª… 2ê¸€ì + í•™ë…„ + ë°˜ + ëœë¤ 4ìë¦¬)
          const schoolCode = schoolName.slice(0, 2);
          const randomCode = Math.random()
            .toString(36)
            .substr(2, 4)
            .toUpperCase();
          const classCode = `${schoolCode}${grade}${classNumber.padStart(
            2,
            "0"
          )}${randomCode}`;

          try {
            // ì„œë²„ì— í•™ê¸‰ ì½”ë“œ ë“±ë¡
            const response = await fetch("/api/admin/create-class-code", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                classCode: classCode,
                schoolName: schoolName,
                grade: parseInt(grade),
                classNumber: parseInt(classNumber),
                pin: currentPin || null,
                teacherCode: currentTeacherCode, // êµì‚¬ ì½”ë“œ ì¶”ê°€
              }),
            });

            const data = await response.json();

            if (data.success) {
              currentSchoolCode = classCode;
              currentClassInfo = {
                schoolName,
                grade: parseInt(grade),
                classNumber: parseInt(classNumber),
              };

              document.getElementById("schoolCode").textContent = classCode;
              document.getElementById("schoolCodeDisplay").style.display =
                "block";

              // í˜„í™© ìƒˆë¡œê³ ì¹¨
              refreshClassStats();

              // [ì¶”ê°€ ê¸°ëŠ¥] QR ìƒì„± í† í° ìš”ì²­ ë° í”„ë¦¬ë·° í‘œì‹œ
              try {
                await generateAndShowQr();
              } catch (e) {
                console.warn("QR ìƒì„± ì‹¤íŒ¨", e);
              }

              alert("í•™ê¸‰ ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
              alert("í•™ê¸‰ ì½”ë“œ ìƒì„± ì‹¤íŒ¨: " + data.error);
            }
          } catch (error) {
            console.error("í•™ê¸‰ ì½”ë“œ ìƒì„± ì˜¤ë¥˜:", error);
            alert("í•™ê¸‰ ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });

      // ì½”ë“œ ë³µì‚¬
      document
        .getElementById("copyCodeBtn")
        .addEventListener("click", function () {
          const code = document.getElementById("schoolCode").textContent;
          navigator.clipboard.writeText(code).then(function () {
            alert("í•™ê¸‰ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + code);
          });
        });

      // í˜„í™© ìƒˆë¡œê³ ì¹¨
      document
        .getElementById("refreshBtn")
        .addEventListener("click", refreshClassStats);

      async function refreshClassStats() {
        if (!currentClassInfo) {
          alert("ë¨¼ì € í•™ê¸‰ ì½”ë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch("/api/admin/class-stats", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...currentClassInfo,
              classCode: currentTeacherAuth.classCode,
              pin: currentTeacherAuth.pin,
            }), // [ê°œì„ ëœ ê¸°ëŠ¥] êµì‚¬ ì¸ì¦
          });

          const data = await response.json();

          if (data.success) {
            updateStats(data.stats);
            updateStudentsTable(data.students);
            // [ì¶”ê°€ ê¸°ëŠ¥] íˆíŠ¸ë§µ ê°±ì‹ 
            await refreshHeatmap();
          } else {
            console.error("í˜„í™© ì¡°íšŒ ì‹¤íŒ¨:", data.error);
          }
        } catch (error) {
          console.error("í˜„í™© ì¡°íšŒ ì˜¤ë¥˜:", error);
        }
      }

      function updateStats(stats) {
        document.getElementById("totalStudents").textContent =
          stats.totalStudents;
        document.getElementById("completedStudents").textContent =
          stats.completedStudents;
        document.getElementById("averageProgress").textContent =
          stats.averageProgress + "%";
      }

      function updateStudentsTable(students) {
        const tbody = document.getElementById("studentsTableBody");
        tbody.innerHTML = "";

        if (students.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: #666;">ì•„ì§ ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        students.forEach((student) => {
          const row = document.createElement("tr");
          const completionRate = Math.round(
            (student.completedPages.length / 7) * 100
          );
          const lastAccess = new Date(student.lastAccess).toLocaleDateString(
            "ko-KR"
          );

          // [ì¶”ê°€ ê¸°ëŠ¥] ì´ë¦„ ë§ˆìŠ¤í‚¹/ì´ë‹ˆì…œ ì²˜ë¦¬, íˆ´íŒìœ¼ë¡œ ì „ì²´ ë…¸ì¶œ
          const displayName = demoMode
            ? `${(student.studentName || "").slice(0, 1)}*`
            : `${(student.studentName || "").slice(0, 1)}*`;
          const nameCell = `<span title="${
            student.studentName || ""
          }">${displayName}</span>`;

          row.innerHTML = `
                    <td>${student.studentNumber}</td>
                    <td>${nameCell}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${completionRate}%"></div>
                        </div>
                        ${student.completedPages.length}/7 ë‹¨ê³„
                    </td>
                    <td>${completionRate}%</td>
                    <td>${lastAccess}</td>
                `;
          tbody.appendChild(row);
        });
      }

      // [ì¶”ê°€ ê¸°ëŠ¥] QR ìƒì„±/í‘œì‹œ/ë‹¤ìš´ë¡œë“œ/ë³µì‚¬
      async function generateAndShowQr() {
        if (!currentSchoolCode) return;
        const days = parseInt(
          document.getElementById("qrDays").value || "7",
          10
        );
        const r = await fetch("/api/admin/qr-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            classCode: currentSchoolCode,
            pin: currentPin || null,
            expiresInSec: days * 86400,
          }),
        });
        if (!r.ok) throw new Error("QR í† í° ìƒì„± ì‹¤íŒ¨");
        const data = await r.json();
        if (!data.success) throw new Error("QR ì‘ë‹µ ì‹¤íŒ¨");
        const imgUrl = `/api/admin/qr.png?token=${encodeURIComponent(
          data.token
        )}`;
        document.getElementById("qrImg").src = imgUrl;
        document.getElementById("qrArea").style.display = "grid";
        const shortUrl = data.shortUrl;
        const input = document.getElementById("shortUrl");
        input.value = shortUrl;
        document.getElementById("downloadPngBtn").onclick = () => {
          const a = document.createElement("a");
          a.href = imgUrl;
          a.download = `${currentSchoolCode}.png`;
          a.click();
        };
      }
      document
        .getElementById("copyShortUrlBtn")
        .addEventListener("click", async () => {
          const v = document.getElementById("shortUrl").value;
          try {
            await navigator.clipboard.writeText(v);
            showToast("URLì„ ë³µì‚¬í–ˆì–´ìš”");
          } catch (e) {
            alert("ë³µì‚¬ ì‹¤íŒ¨");
          }
        });

      // [ì¶”ê°€ ê¸°ëŠ¥] ê°œì… ì•Œë¦¼ í´ë§ (8ì´ˆ)
      async function pollInterventions() {
        if (!currentSchoolCode) return;
        try {
          const r = await fetch(
            `/api/admin/interventions?classCode=${encodeURIComponent(
              currentSchoolCode
            )}&pin=${encodeURIComponent(currentPin || "")}`
          );
          if (!r.ok) return;
          const data = await r.json();
          if (!data.success) return;
          renderInterventions(data.items || []);
        } catch (e) {}
      }
      setInterval(pollInterventions, 8000);

      function renderInterventions(items) {
        const list = document.getElementById("interventionsList");
        list.innerHTML = "";
        if (!items.length) {
          list.innerHTML =
            '<div style="color:#8d6e63;font-size:14px">ìµœê·¼ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        items.slice(0, 20).forEach((it) => {
          const row = document.createElement("div");
          row.className = "intervention-item";
          const initial = (it.studentName || "").slice(0, 1) + "*";
          const label = `[${it.studentNumber}/${initial}] ë‹¨ê³„${
            it.stage
          }, ê²½ê³¼${Math.round(it.elapsed || 0)}ì´ˆ, ì‚¬ìœ :${it.reason}${
            it.errorTags && it.errorTags.length
              ? `, ìµœê·¼íƒœê·¸:${it.errorTags[0]}`
              : ""
          }`;
          const left = document.createElement("div");
          left.textContent = label;
          left.setAttribute("aria-label", label);
          const btn = document.createElement("button");
          btn.className = "btn-linkcopy";
          btn.textContent = "ê³¼ì œ ë§í¬ ë³µì‚¬";
          btn.onclick = async () => {
            const url = `${location.origin}/page${it.stage}.html`;
            try {
              await navigator.clipboard.writeText(url);
              showToast("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”");
            } catch (e) {
              alert("ë³µì‚¬ ì‹¤íŒ¨");
            }
          };
          row.appendChild(left);
          row.appendChild(btn);
          list.appendChild(row);
        });
      }

      // [ì¶”ê°€ ê¸°ëŠ¥] íˆíŠ¸ë§µ ë¡œë”©/ë Œë”ë§
      async function refreshHeatmap() {
        if (!currentSchoolCode) return;
        const r = await fetch(
          `/api/admin/heatmap?classCode=${encodeURIComponent(
            currentSchoolCode
          )}&pin=${encodeURIComponent(currentPin || "")}`
        );
        if (!r.ok) return;
        const data = await r.json();
        if (!data.success) return;
        renderHeatmap(data.tags, data.rows);
      }
      function renderHeatmap(tagMeta, rows) {
        const table = document.getElementById("heatmapTable");
        const tagKeys = [
          "zeroPadding",
          "unitSwitch",
          "comma",
          "placeValue",
          "magnitude",
          "compareSign",
          "skipCounting",
          "wordParsing",
        ];
        // í—¤ë”
        let thead =
          "<thead><tr><th>ë‹¨ê³„</th>" +
          tagKeys
            .map((k) => {
              const t = tagMeta[k];
              const title = `${t.label}\n${t.definition}\nêµì •íŒ: ${t.tip}`;
              return `<th title="${title}">${t.label}</th>`;
            })
            .join("") +
          "</tr></thead>";
        let tbody = "<tbody>";
        rows.forEach((r) => {
          tbody += `<tr><td>ë‹¨ê³„ ${r.stage}</td>`;
          tagKeys.forEach((k) => {
            const v = r.rates[k] || { rate: 0 };
            const pct = v.rate || 0;
            const bg = `rgba(33, 150, 243, ${Math.min(0.1 + pct / 100, 0.95)})`;
            const title = `${tagMeta[k].label}: ${pct}%\n${tagMeta[k].definition}\nêµì •íŒ: ${tagMeta[k].tip}`;
            tbody += `<td title="${title}"><div class="heatmap-cell" style="background:${bg}; padding:6px"><span class="rate-label">${pct}%</span></div></td>`;
          });
          tbody += "</tr>";
        });
        tbody += "</tbody>";
        table.innerHTML = thead + tbody;
      }

      // [ì¶”ê°€ ê¸°ëŠ¥] í† ìŠ¤íŠ¸
      function showToast(msg) {
        const el = document.getElementById("toast");
        el.textContent = msg;
        el.style.display = "block";
        setTimeout(() => {
          el.style.display = "none";
        }, 1400);
      }

      // ì´ˆê¸° ì„¸ì…˜ ì²´í¬ ë° ì£¼ê¸°ì  ê°œì… í´ë§ ì‹œì‘
      (async () => {
        await ensureTeacherSession();
        setTimeout(pollInterventions, 1000);
        // [ê°œì„ ëœ ê¸°ëŠ¥] ì‹¤ì‹œê°„ í•™êµ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´
        const schoolInput = document.getElementById("schoolName");
        const schoolDropdown = document.getElementById("schoolDropdown");
        let searchTimeout = null;
        let selectedIndex = -1;

        // í•™êµ ê²€ìƒ‰ í•¨ìˆ˜
        async function searchSchools(query) {
          if (!query || query.length < 2) {
            schoolDropdown.style.display = "none";
            return;
          }

          try {
            const r = await fetch(
              `/api/admin/schools?q=${encodeURIComponent(query)}`
            );
            if (!r.ok) return;
            const data = await r.json();

            if (data.schools && data.schools.length > 0) {
              showSchoolDropdown(data.schools, query);
            } else {
              schoolDropdown.innerHTML =
                '<div style="padding: 12px; color: #666; text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
              schoolDropdown.style.display = "block";
            }
          } catch (e) {
            console.error("í•™êµ ê²€ìƒ‰ ì˜¤ë¥˜:", e);
            schoolDropdown.style.display = "none";
          }
        }

        // ë“œë¡­ë‹¤ìš´ í‘œì‹œ í•¨ìˆ˜
        function showSchoolDropdown(schools, query) {
          schoolDropdown.innerHTML = "";
          selectedIndex = -1;

          schools.forEach((schoolName, index) => {
            const item = document.createElement("div");
            item.style.cssText = `
              padding: 12px 16px;
              cursor: pointer;
              border-bottom: 1px solid #f0f0f0;
              transition: background-color 0.2s;
            `;

            // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
            const highlightedName = schoolName.replace(
              new RegExp(`(${query})`, "gi"),
              '<span style="background: #fff3cd; font-weight: bold;">$1</span>'
            );
            item.innerHTML = highlightedName;

            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            item.addEventListener("mouseenter", () => {
              clearSelection();
              item.style.backgroundColor = "#e8f5e8";
              selectedIndex = index;
            });

            item.addEventListener("mouseleave", () => {
              item.style.backgroundColor = "transparent";
            });

            // í´ë¦­ ì´ë²¤íŠ¸
            item.addEventListener("click", () => {
              selectSchool(schoolName);
            });

            schoolDropdown.appendChild(item);
          });

          schoolDropdown.style.display = "block";
        }

        // í•™êµ ì„ íƒ í•¨ìˆ˜
        function selectSchool(schoolName) {
          schoolInput.value = schoolName;
          schoolDropdown.style.display = "none";
          selectedIndex = -1;
          document.getElementById(
            "schoolSearchHint"
          ).innerHTML = `âœ… <span style="color: #4caf50; font-weight: bold;">${schoolName}</span>ì´(ê°€) ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`;
        }

        // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        function clearSelection() {
          const items = schoolDropdown.children;
          for (let item of items) {
            item.style.backgroundColor = "transparent";
          }
        }

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        schoolInput.addEventListener("keydown", (e) => {
          const items = schoolDropdown.children;
          if (schoolDropdown.style.display === "none" || items.length === 0)
            return;

          switch (e.key) {
            case "ArrowDown":
              e.preventDefault();
              selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
              updateSelection();
              break;
            case "ArrowUp":
              e.preventDefault();
              selectedIndex = Math.max(selectedIndex - 1, -1);
              updateSelection();
              break;
            case "Enter":
              e.preventDefault();
              if (selectedIndex >= 0 && selectedIndex < items.length) {
                const schoolName = items[selectedIndex].textContent;
                selectSchool(schoolName);
              }
              break;
            case "Escape":
              schoolDropdown.style.display = "none";
              selectedIndex = -1;
              break;
          }
        });

        // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSelection() {
          clearSelection();
          const items = schoolDropdown.children;
          if (selectedIndex >= 0 && selectedIndex < items.length) {
            items[selectedIndex].style.backgroundColor = "#e8f5e8";
          }
        }

        // ì…ë ¥ ì´ë²¤íŠ¸
        schoolInput.addEventListener("input", (e) => {
          const query = e.target.value.trim();

          // íŒíŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          if (query.length === 0) {
            document.getElementById("schoolSearchHint").innerHTML =
              "ğŸ’¡ í•™êµëª…ì˜ ì¼ë¶€ë§Œ ì…ë ¥í•´ë„ ê²€ìƒ‰ë©ë‹ˆë‹¤ (ìµœì†Œ 2ê¸€ì)";
          } else if (query.length === 1) {
            document.getElementById("schoolSearchHint").innerHTML =
              "ğŸ” í•œ ê¸€ì ë” ì…ë ¥í•˜ë©´ ê²€ìƒ‰ì´ ì‹œì‘ë©ë‹ˆë‹¤";
          }

          // ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            searchSchools(query);
          }, 300);
        });

        // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
        document.addEventListener("click", (e) => {
          if (
            !schoolInput.contains(e.target) &&
            !schoolDropdown.contains(e.target)
          ) {
            schoolDropdown.style.display = "none";
            selectedIndex = -1;
          }
        });
      })();
    </script>
  </body>
</html>
