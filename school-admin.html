<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ - í°ìˆ˜í•™ìŠµ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .admin-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
      }

      .admin-header {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 30px;
      }

      .admin-sections {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .admin-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid #e3f2fd;
      }

      .section-title {
        color: #1976d2;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .school-code-display {
        background: #f8f9fa;
        border: 2px dashed #4caf50;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin: 15px 0;
      }

      .school-code {
        font-size: 24px;
        font-weight: bold;
        color: #2e7d32;
        font-family: "Courier New", monospace;
        letter-spacing: 2px;
      }

      .students-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .students-table th,
      .students-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .students-table th {
        background: #f5f5f5;
        font-weight: bold;
        color: #333;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .btn-primary {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
      }

      .btn-primary:hover {
        background: #45a049;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #2196f3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat-card {
        background: linear-gradient(135deg, #e3f2fd, #f1f8e9);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        border: 2px solid #4caf50;
      }

      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #2e7d32;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .copy-button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
      }

      @media (max-width: 768px) {
        .admin-sections {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="admin-container">
        <div class="admin-header">
          <h1>ğŸ‘©â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€</h1>
          <p>í•™ê¸‰ ê´€ë¦¬ ë° í•™ìƒ ì§„ë„ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="admin-sections">
          <div class="admin-section">
            <div class="section-title">ğŸ« í•™êµ ì •ë³´ ì„¤ì •</div>

            <div class="form-group">
              <label>í•™êµëª…</label>
              <input
                type="text"
                id="schoolName"
                placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ"
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>í•™ë…„</label>
                <select id="grade">
                  <option value="">ì„ íƒ</option>
                  <option value="1">1í•™ë…„</option>
                  <option value="2">2í•™ë…„</option>
                  <option value="3">3í•™ë…„</option>
                  <option value="4">4í•™ë…„</option>
                  <option value="5">5í•™ë…„</option>
                  <option value="6">6í•™ë…„</option>
                </select>
              </div>
              <div class="form-group">
                <label>ë°˜</label>
                <select id="classNumber">
                  <option value="">ì„ íƒ</option>
                  <option value="1">1ë°˜</option>
                  <option value="2">2ë°˜</option>
                  <option value="3">3ë°˜</option>
                  <option value="4">4ë°˜</option>
                  <option value="5">5ë°˜</option>
                  <option value="6">6ë°˜</option>
                  <option value="7">7ë°˜</option>
                  <option value="8">8ë°˜</option>
                  <option value="9">9ë°˜</option>
                  <option value="10">10ë°˜</option>
                </select>
              </div>
            </div>

            <button class="btn-primary" id="generateCodeBtn">
              í•™ê¸‰ ì½”ë“œ ìƒì„±
            </button>

            <div
              id="schoolCodeDisplay"
              class="school-code-display"
              style="display: none"
            >
              <div>ğŸ“‹ í•™ìƒ ë“±ë¡ ì½”ë“œ</div>
              <div class="school-code" id="schoolCode"></div>
              <button class="copy-button" id="copyCodeBtn">ì½”ë“œ ë³µì‚¬</button>
              <div style="margin-top: 15px; font-size: 14px; color: #666">
                í•™ìƒë“¤ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!<br />
                ë“±ë¡í•  ë•Œ "í•™ê¸‰ ì½”ë“œë¡œ ë“±ë¡" ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>

          <div class="admin-section">
            <div class="section-title">ğŸ“Š í•™ê¸‰ í˜„í™©</div>

            <div class="stats-grid" id="statsGrid">
              <div class="stat-card">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">ì „ì²´ í•™ìƒ</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="completedStudents">0</div>
                <div class="stat-label">ì™„ë£Œ í•™ìƒ</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="averageProgress">0%</div>
                <div class="stat-label">í‰ê·  ì§„ë„</div>
              </div>
            </div>

            <button class="btn-secondary" id="refreshBtn">í˜„í™© ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>

        <div class="admin-section">
          <div class="section-title">ğŸ‘¥ í•™ìƒ ëª©ë¡ ë° ì§„ë„</div>

          <table class="students-table" id="studentsTable">
            <thead>
              <tr>
                <th>ë²ˆí˜¸</th>
                <th>ì´ë¦„</th>
                <th>ì§„ë„</th>
                <th>ì™„ë£Œìœ¨</th>
                <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
              </tr>
            </thead>
            <tbody id="studentsTableBody">
              <tr>
                <td colspan="5" style="text-align: center; color: #666">
                  í•™ê¸‰ ì½”ë“œë¥¼ ìƒì„±í•˜ê³  í˜„í™©ì„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script>
      let currentSchoolCode = null;
      let currentClassInfo = null;

      // í•™ê¸‰ ì½”ë“œ ìƒì„±
      document
        .getElementById("generateCodeBtn")
        .addEventListener("click", async function () {
          const schoolName = document.getElementById("schoolName").value;
          const grade = document.getElementById("grade").value;
          const classNumber = document.getElementById("classNumber").value;

          if (!schoolName || !grade || !classNumber) {
            alert("í•™êµëª…, í•™ë…„, ë°˜ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          // í•™ê¸‰ ì½”ë“œ ìƒì„± (í•™êµëª… 2ê¸€ì + í•™ë…„ + ë°˜ + ëœë¤ 4ìë¦¬)
          const schoolCode = schoolName.slice(0, 2);
          const randomCode = Math.random()
            .toString(36)
            .substr(2, 4)
            .toUpperCase();
          const classCode = `${schoolCode}${grade}${classNumber.padStart(
            2,
            "0"
          )}${randomCode}`;

          try {
            // ì„œë²„ì— í•™ê¸‰ ì½”ë“œ ë“±ë¡
            const response = await fetch("/api/admin/create-class-code", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                classCode: classCode,
                schoolName: schoolName,
                grade: parseInt(grade),
                classNumber: parseInt(classNumber),
              }),
            });

            const data = await response.json();

            if (data.success) {
              currentSchoolCode = classCode;
              currentClassInfo = {
                schoolName,
                grade: parseInt(grade),
                classNumber: parseInt(classNumber),
              };

              document.getElementById("schoolCode").textContent = classCode;
              document.getElementById("schoolCodeDisplay").style.display =
                "block";

              // í˜„í™© ìƒˆë¡œê³ ì¹¨
              refreshClassStats();

              alert("í•™ê¸‰ ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
              alert("í•™ê¸‰ ì½”ë“œ ìƒì„± ì‹¤íŒ¨: " + data.error);
            }
          } catch (error) {
            console.error("í•™ê¸‰ ì½”ë“œ ìƒì„± ì˜¤ë¥˜:", error);
            alert("í•™ê¸‰ ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });

      // ì½”ë“œ ë³µì‚¬
      document
        .getElementById("copyCodeBtn")
        .addEventListener("click", function () {
          const code = document.getElementById("schoolCode").textContent;
          navigator.clipboard.writeText(code).then(function () {
            alert("í•™ê¸‰ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: " + code);
          });
        });

      // í˜„í™© ìƒˆë¡œê³ ì¹¨
      document
        .getElementById("refreshBtn")
        .addEventListener("click", refreshClassStats);

      async function refreshClassStats() {
        if (!currentClassInfo) {
          alert("ë¨¼ì € í•™ê¸‰ ì½”ë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch("/api/admin/class-stats", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(currentClassInfo),
          });

          const data = await response.json();

          if (data.success) {
            updateStats(data.stats);
            updateStudentsTable(data.students);
          } else {
            console.error("í˜„í™© ì¡°íšŒ ì‹¤íŒ¨:", data.error);
          }
        } catch (error) {
          console.error("í˜„í™© ì¡°íšŒ ì˜¤ë¥˜:", error);
        }
      }

      function updateStats(stats) {
        document.getElementById("totalStudents").textContent =
          stats.totalStudents;
        document.getElementById("completedStudents").textContent =
          stats.completedStudents;
        document.getElementById("averageProgress").textContent =
          stats.averageProgress + "%";
      }

      function updateStudentsTable(students) {
        const tbody = document.getElementById("studentsTableBody");
        tbody.innerHTML = "";

        if (students.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: #666;">ì•„ì§ ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        students.forEach((student) => {
          const row = document.createElement("tr");
          const completionRate = Math.round(
            (student.completedPages.length / 7) * 100
          );
          const lastAccess = new Date(student.lastAccess).toLocaleDateString(
            "ko-KR"
          );

          row.innerHTML = `
                    <td>${student.studentNumber}</td>
                    <td>${student.studentName}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${completionRate}%"></div>
                        </div>
                        ${student.completedPages.length}/7 ë‹¨ê³„
                    </td>
                    <td>${completionRate}%</td>
                    <td>${lastAccess}</td>
                `;
          tbody.appendChild(row);
        });
      }
    </script>
  </body>
</html>
